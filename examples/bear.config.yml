name: acme-platform

languages:
  - name: go
    detection:
      files: [go.mod]
    validation:
      setup:
        - name: Download modules
          run: go mod download
      lint:
        - name: Vet
          run: go vet ./...
      test:
        - name: Test
          run: go test -race -cover ./...
      build:
        - name: Build
          run: go build -o dist/app .

  - name: node
    detection:
      files: [package.json]
    validation:
      setup:
        - name: Install
          run: npm install --prefer-offline
      lint:
        - name: Lint
          run: npm run lint --if-present
      test:
        - name: Test
          run: npm test --if-present
      build:
        - name: Build
          run: npm run build --if-present

  - name: python
    detection:
      files: [pyproject.toml, requirements.txt]
    validation:
      setup:
        - name: Check Python
          run: python3 --version
      lint:
        - name: Syntax Check
          run: python3 -m py_compile *.py
      test:
        - name: Test
          run: python3 -m pytest --tb=short 2>/dev/null || python3 -c "print('No pytest, skipping')"

targets:
  - name: cloudrun
    defaults:
      REGION: europe-west1
      MEMORY: 512Mi
    deploy:
      - name: Build
        run: docker build -t gcr.io/$PROJECT/$NAME:$VERSION .
      - name: Push
        run: docker push gcr.io/$PROJECT/$NAME:$VERSION
      - name: Deploy
        run: |
          gcloud run deploy $NAME \
            --image gcr.io/$PROJECT/$NAME:$VERSION \
            --region $REGION \
            --memory $MEMORY

  - name: cloudrun-job
    defaults:
      REGION: europe-west1
    deploy:
      - name: Build
        run: docker build -t gcr.io/$PROJECT/$NAME:$VERSION .
      - name: Push
        run: docker push gcr.io/$PROJECT/$NAME:$VERSION
      - name: Deploy
        run: gcloud run jobs deploy $NAME --image gcr.io/$PROJECT/$NAME:$VERSION --region $REGION

  - name: lambda
    deploy:
      - name: Package
        run: zip -r dist.zip .
      - name: Deploy
        run: aws lambda update-function-code --function-name $NAME --zip-file fileb://dist.zip

  - name: s3-static
    deploy:
      - name: Sync
        run: aws s3 sync ./dist s3://$BUCKET --delete
      - name: Invalidate
        run: aws cloudfront create-invalidation --distribution-id $CF_DIST --paths "/*"

  - name: docker-local
    defaults:
      PORT: 8080
    deploy:
      - name: Build Image
        run: podman build -t $NAME:$VERSION .
      - name: Stop Existing
        run: podman stop $NAME 2>/dev/null || true
      - name: Remove Existing
        run: podman rm $NAME 2>/dev/null || true
      - name: Start Container
        run: podman run -d --name $NAME -p $PORT:8080 -e PORT=8080 $NAME:$VERSION
